<title>Riverside Mutual Aid Map</title>

<link rel="icon" href="https://img.icons8.com/cotton/2x/like.png" type="image/png" sizes="16x16">
		
<script>
	function initMap() {
		var xmlHttp = new XMLHttpRequest();
		xmlHttp.onreadystatechange = function() {
			if (xmlHttp.readyState != 4) {
				return;
			}
			if (!xmlHttp.response) {
				return;
			}
			var volunteerData = JSON.parse(xmlHttp.response);
			setupMap(volunteerData.feed.entry);
		}
		xmlHttp.open("GET", "https://spreadsheets.google.com/feeds/cells/1V4F02LbP8feQXTKX_l1ES9kv4udM09l59KPWr4r4J9w/1/public/full?alt=json", true);
		xmlHttp.send(null);
	}

	function setupMap(entries) {
		var map = new google.maps.Map(document.getElementById('map'), {
			zoom: 15,
			center: {
				lat: 51.486, 
				lng: -3.199
			}
		});
		createMarkers(map, entries);
	}
	
	function createMarkers(map, entries) {
		var postalCodes = [];
		var markerData = {};
		var rowIndex = 8;
		while (true) {
			if (entries[rowIndex].content["$t"] === "Grand Total") {
				break;
			}
			var postalCode = entries[rowIndex + 3].content["$t"];
			postalCode = postalCode.replace(/\s+/g, '');
			postalCode = postalCode.toLowerCase();
			if (!postalCodes.includes(postalCode)) {
				postalCodes.push(postalCode);
			}
			if (!markerData.hasOwnProperty(postalCode)) {
				markerData[postalCode] = {
					"volunteers": [],
					"trainingDates": [],
					"streetChampion": [],
					"trained": [],
					"interestedInChampion": []
				};
			}
			markerData[postalCode].volunteers.push(entries[rowIndex + 1].content["$t"]);
			markerData[postalCode].trainingDates.push(entries[rowIndex + 4].content["$t"]);
			markerData[postalCode].streetChampion.push(entries[rowIndex + 5].content["$t"]);
			markerData[postalCode].trained.push(entries[rowIndex + 6].content["$t"]);
			markerData[postalCode].interestedInChampion.push(entries[rowIndex + 7].content["$t"]);
			rowIndex += 8;
		}
		var xmlHttp = new XMLHttpRequest();
		xmlHttp.onreadystatechange = function() {
			if (xmlHttp.readyState != 4) {
				return;
			}
			if (!xmlHttp.response) {
				return;
			}
			var locationData = JSON.parse(xmlHttp.response);
			locationData.result.forEach(entry => {
				var infoWindowContent = "";
				var postalCode = entry.result.postcode;
				postalCode = postalCode.replace(/\s+/g, '');
				postalCode = postalCode.toLowerCase();
				for (var i = 0; i < markerData[postalCode].volunteers.length; i++) {
					infoWindowContent += "<p>" + markerData[postalCode].volunteers[i] + 
						" - Training Date: " + markerData[postalCode].trainingDates[i] + 
						", Street Champion: " + markerData[postalCode].streetChampion[i] + 
						", Trained: " + markerData[postalCode].trained[i] + 
						", Interested in Being Street Champion: " + markerData[postalCode].interestedInChampion[i] + "</p>";
				}
				var infoWindow = new google.maps.InfoWindow({
					content: infoWindowContent
				});
				var marker = new google.maps.Marker({
					position: {
						lat: entry.result.latitude,
						lng: entry.result.longitude
					},
					map: map
				});
				marker.addListener('click', function() {
					infoWindow.open(map, marker);
				});
			});
		}
		xmlHttp.open("POST", "https://api.postcodes.io/postcodes");
		xmlHttp.setRequestHeader("Content-Type", "application/json");
		xmlHttp.send(JSON.stringify({"postcodes" : postalCodes}));
	}
</script>

<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD8vc1RPEOEOOeqHIzTMsbWyNo8gk-sw_0&callback=initMap"></script>

<div id="map" style="width:100%; height:100%;"></div>